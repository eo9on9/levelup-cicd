# GitHub Actions 워크플로우 이름
# PR 화면 / Actions 탭에서 표시됨
name: PR Check

# 워크플로우가 실행되는 트리거 조건
on:
  # Pull Request 이벤트 기준으로 실행
  pull_request:
    # main 브랜치로 들어가는 PR만 대상으로 함
    # (모든 PR에서 돌리고 싶으면 branches 조건 제거)
    # branches:
    #   - main

# 실행할 작업(job) 정의
jobs:
  # job의 식별자 (자유롭게 이름 지정 가능)
  pr-check:
    # 이 job을 실행할 GitHub 제공 러너(OS)
    # 프론트엔드 CI의 기본값
    runs-on: ubuntu-latest

    # job 안에서 순차적으로 실행될 step 목록
    steps:
      # GitHub 저장소의 코드를 러너로 체크아웃(복사)
      # 이 단계가 없으면 코드 자체가 없음
      - name: Checkout repository
        uses: actions/checkout@v4

      # Node.js 실행 환경 설정
      # node-version은 로컬/CI 간 버전 일관성을 위해 고정
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.21.0

      # pnpm 설치
      # corepack은 Node 16+ 에 기본 포함
      # cache를 사용하려면 pnpm을 먼저 활성화해야 함
      - name: Enable pnpm
        run: corepack enable

      # pnpm 캐시 설정
      # 의존성 설치 속도 향상
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      # pnpm store 디렉터리를 GitHub 캐시로 관리
      # 이전 CI 실행에서 저장된 의존성 캐시를 복원하거나,
      # 현재 실행이 끝난 후 새 캐시를 저장함
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          # 캐시할 실제 파일 경로
          # pnpm이 다운로드한 패키지들이 저장되는 store 디렉터리
          # (OS / pnpm 버전에 따라 경로가 달라질 수 있어
          #  이전 step에서 동적으로 조회한 값을 사용)
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          # 캐시를 식별하는 고유 키
          # - runner.os: OS별로 캐시 분리 (Linux / macOS / Windows)
          # - pnpm-store: 캐시 종류 식별자
          # - hashFiles('**/pnpm-lock.yaml'):
          #   lockfile 내용이 바뀌면 해시가 달라져
          #   의존성 변경 시 캐시가 자동으로 무효화됨
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          # 정확한 key가 없을 때 사용할 보조 키
          # 동일한 OS의 이전 pnpm store 캐시라도 우선 복원해서
          # 전체 다운로드를 줄이고 CI 속도를 개선
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 의존성 설치
      # CI 환경에서는 항상 npm ci 사용 (lockfile 기준, 재현성 보장)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ESLint 실행
      # 로컬에서 사용하는 npm script를 그대로 재사용
      # 린트 에러 발생 시 PR 체크 실패
      - name: Run ESLint
        run: pnpm run lint

      # TypeScript 타입 체크
      # 빌드 없이 타입 오류만 검증
      - name: Run TypeScript type check
        run: pnpm run type-check

      # 테스트 실행
      # 단위/통합 테스트 검증
      - name: Run tests
        run: pnpm test
